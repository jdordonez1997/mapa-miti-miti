<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>PROYECTOS DE VIVIENDA MITI - MITI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="icon" href="data:," />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }

    .app {
      height: 100%;
      display: grid;
      grid-template-columns: 340px 1fr 360px; /* izquierda - mapa - derecha */
    }

    .panel {
      padding: 14px 14px 12px 14px;
      background: #fff;
      overflow: auto;
    }
    .panel.left { border-right: 1px solid #ddd; }
    .panel.right { border-left: 1px solid #ddd; background: #fafafa; }

    .header { display:flex; flex-direction:column; align-items:flex-start; gap:6px; margin-bottom:10px; }
    .header img { height: 38px; width: auto; display:block; }

    .panel h1 {
      font-size: 16px;
      margin: 0;
      font-weight: 700;
      text-transform: uppercase;
      line-height: 1.25;
    }

    .muted {
      color: #666;
      font-size: 12px;
      margin-bottom: 12px;
      line-height: 1.3;
    }

    label { display:block; font-size:12px; margin:10px 0 6px 0; font-weight:700; }

    select, input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 13px;
      outline: none;
      box-sizing: border-box;
      background: #fff;
    }

    .btn {
      margin-top: 10px;
      width: 100%;
      padding: 9px 10px;
      border: 1px solid #222;
      background: #222;
      color: white;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
    }
    .btn.secondary { background:#fff; color:#222; }

    .stats {
      margin-top: 10px;
      font-size: 12px;
      color: #333;
      padding: 10px;
      border-radius: 10px;
      background: #f6f6f6;
      line-height: 1.4;
    }

    .footer {
      margin-top: 12px;
      font-size: 11px;
      color: #666;
      line-height: 1.35;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 12px;
      color: #222;
      user-select: none;
    }
    .toggle input { width: auto; }

    #map { height: 100%; }

    /* Marker (divIcon) */
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #2E7DF6;
      border: 1px solid rgba(0,0,0,0.25);
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }
    .dot.selected {
      width: 12px;
      height: 12px;
      border: 2px solid rgba(0,0,0,0.35);
      box-shadow: 0 2px 5px rgba(0,0,0,0.25);
    }

    /* Panel derecho (detalle) */
    .detail-card {
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .detail-title {
      font-size: 14px;
      font-weight: 800;
      margin: 0 0 10px 0;
      line-height: 1.25;
    }

    .detail-actions {
      display:flex;
      gap:8px;
      margin: 10px 0 0 0;
    }

    .mini-btn {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #222;
      background: #fff;
      color: #222;
      cursor: pointer;
      font-size: 12px;
      font-weight: 700;
      flex: 1;
    }

    table.detail-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    table.detail-table th {
      text-align: left;
      vertical-align: top;
      padding: 5px 10px 5px 0;
      white-space: nowrap;
      color: #333;
    }
    table.detail-table td {
      padding: 5px 0;
      word-break: break-word;
      color: #111;
    }

    .hint {
      color:#666;
      font-size: 12px;
      line-height:1.35;
    }

    /* Responsive */
    @media (max-width: 1100px) {
      .app { grid-template-columns: 320px 1fr 320px; }
    }
    @media (max-width: 900px) {
      /* En móvil apilamos: filtros arriba, mapa, detalle abajo */
      .app { grid-template-columns: 1fr; grid-template-rows: 280px 1fr 260px; }
      .panel.left { border-right: none; border-bottom: 1px solid #ddd; }
      .panel.right { border-left: none; border-top: 1px solid #ddd; }
    }
  </style>
</head>

<body>
<div class="app">

  <!-- PANEL IZQUIERDO -->
  <div class="panel left">
    <div class="header">
      <img id="logoInst"
           src="logo_institucional.jpg"
           alt="Logo institucional"
           onerror="window.__logoFallback && window.__logoFallback(this);" />
      <h1>PROYECTOS DE VIVIENDA MITI - MITI</h1>
    </div>

    <div class="muted">
      Filtra por provincia y cantón. La búsqueda aplica automáticamente mientras escribes.
    </div>

    <label for="provinciaSelect">Provincia</label>
    <select id="provinciaSelect">
      <option value="">(Todas)</option>
    </select>

    <label for="cantonSelect">Cantón</label>
    <select id="cantonSelect" disabled>
      <option value="">(Todos)</option>
    </select>

    <label for="buscarInput">Buscar (proyecto / promotor / registro)</label>
    <input id="buscarInput" type="text" placeholder="Ej: Galilea, MIDUVI..., Los Prados..." />

    <div class="toggle">
      <input type="checkbox" id="clusterToggle" checked />
      <label for="clusterToggle" style="margin:0; font-weight:700;">Agrupar puntos (clúster)</label>
    </div>

    <button class="btn secondary" id="limpiarBtn">Limpiar</button>

    <div class="stats" id="statsBox">Cargando datos…</div>

    <div class="footer">
      <strong>Fuente:</strong> Registro de Viviendas del Programa Miti-Miti – Ministerio de Infraestructura y Transporte.<br>
      <strong>Actualización:</strong> <span id="fechaActualizacion">2026-01-21</span>
    </div>
  </div>

  <!-- MAPA -->
  <div id="map"></div>

  <!-- PANEL DERECHO (DETALLE) -->
  <div class="panel right">
    <h1 style="margin-bottom:10px;">DETALLE DEL PROYECTO</h1>

    <div class="detail-card" id="detailCard">
      <div class="hint">
        Haz clic en un punto del mapa para ver aquí la información del proyecto.
      </div>
    </div>
  </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
  // ====== FALLBACK DE LOGO ======
  window.__logoFallback = (function(){
    const candidates = [
      "logo_institucional.jpg",
      "logo_institucional.jpeg",
      "logo_institucional.png",
      "logo_institucional.svg",
      "logo_institucional"
    ];
    let idx = 0;
    return function(img){
      idx++;
      if (idx >= candidates.length) { img.style.display = "none"; return; }
      img.onerror = function(){ window.__logoFallback(img); };
      img.src = candidates[idx];
    };
  })();

  // ====== CONFIG ======
  const DATA_URL = 'miti_miti_proyectos.geojson';
  const FECHA_ACTUALIZACION = '2026-01-21';
  document.getElementById('fechaActualizacion').textContent = FECHA_ACTUALIZACION;

  // ====== MAPA ======
  const map = L.map('map', { preferCanvas: true }).setView([-1.5, -78.5], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(map);

  let plainLayer = L.layerGroup().addTo(map);
  let clusterLayer = L.markerClusterGroup({
    chunkedLoading: true,
    removeOutsideVisibleBounds: true,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    maxClusterRadius: 45
  });

  // ====== UI ======
  const provinciaSelect = document.getElementById('provinciaSelect');
  const cantonSelect = document.getElementById('cantonSelect');
  const buscarInput = document.getElementById('buscarInput');
  const limpiarBtn = document.getElementById('limpiarBtn');
  const clusterToggle = document.getElementById('clusterToggle');
  const statsBox = document.getElementById('statsBox');

  const detailCard = document.getElementById('detailCard');

  // ====== ESTADO ======
  let allFeatures = [];
  let currentFiltered = [];

  // Para resaltar el seleccionado
  let selectedMarker = null;
  const normalIcon = L.divIcon({ className: "", html: `<div class="dot"></div>`, iconSize: [10,10], iconAnchor: [5,5] });
  const selectedIcon = L.divIcon({ className: "", html: `<div class="dot selected"></div>`, iconSize: [12,12], iconAnchor: [6,6] });

  // ====== UTIL ======
  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    }[m]));
  }

  function normalizeStr(s) { return String(s ?? "").toUpperCase().trim(); }

  function getProp(props, keys) {
    for (const k of keys) {
      if (k in props && props[k] !== null && props[k] !== undefined && String(props[k]).trim() !== "") {
        return props[k];
      }
    }
    return "";
  }

  function getProvincia(props){ return getProp(props, ["PROVINCIA","Provincia","provincia"]); }
  function getCanton(props){ return getProp(props, ["CANTÓN","CANTON","Canton","cantón","canton"]); }
  function getPromotor(props){ return getProp(props, ["PROMOTOR_","PROMOTOR","PROMOTOR ","PROMOTOR_ "]); }

  function formatValue(keyLabel, val) {
    if (val === null || val === undefined) return "";
    const s = String(val).trim();
    if (!s) return "";
    if (keyLabel === "WEB") {
      let u = s;
      if (u && !/^https?:\/\//i.test(u)) u = "https://" + u;
      return `<a href="${escapeHtml(u)}" target="_blank" rel="noopener">${escapeHtml(u)}</a>`;
    }
    return escapeHtml(s);
  }

  // Etiquetas “bonitas”
  const LABELS = {
    "NRO_REGIS": "REGISTRO",
    "PROYECTO": "PROYECTO",
    "PROVINCIA": "PROVINCIA",
    "CANTÓN": "CANTÓN",
    "CANTON": "CANTÓN",
    "PARROQUIA": "PARROQUIA",
    "SECTOR": "SECTOR",
    "VIVIENDAS": "VIVIENDAS",
    "TIPO_VIVIE": "TIPO VIVIENDA",
    "CONTACTO": "CONTACTO",
    "MAIL": "EMAIL",
    "WEB": "WEB",
    "PROMOTOR_": "PROMOTOR",
    "PROMOTOR": "PROMOTOR"
  };

  const PREFERRED_ORDER = [
    "NRO_REGIS",
    "PROYECTO",
    "PROVINCIA",
    "CANTÓN","CANTON",
    "PARROQUIA",
    "SECTOR",
    "VIVIENDAS",
    "TIPO_VIVIE",
    "PROMOTOR_","PROMOTOR",
    "CONTACTO",
    "MAIL",
    "WEB"
  ];

  function setStats(total, shown, prov, canton, q) {
    statsBox.innerHTML = `
      <strong>Total:</strong> ${total.toLocaleString()}<br>
      <strong>Mostrando:</strong> ${shown.toLocaleString()}<br>
      <strong>Provincia:</strong> ${prov || "(Todas)"}<br>
      <strong>Cantón:</strong> ${canton || "(Todos)"}<br>
      <strong>Búsqueda:</strong> ${q ? escapeHtml(q) : "(Ninguna)"}<br>
      <strong>Actualización:</strong> ${escapeHtml(FECHA_ACTUALIZACION)}
    `;
  }

  function debounce(fn, ms) {
    let t = null;
    return function(...args) { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), ms); };
  }

  function getUniqueSorted(arr) {
    return Array.from(new Set(arr)).filter(Boolean).sort((a,b) => a.localeCompare(b));
  }

  // ====== DETALLE A LA DERECHA ======
  function renderDetail(props, markerLatLng) {
    props = props || {};

    const proyecto = getProp(props, ["PROYECTO","Proyecto","PROYECTO "]);
    const title = proyecto ? escapeHtml(proyecto) : "Detalle del proyecto";

    // Orden: preferidos, luego extras
    const keysInProps = Object.keys(props);
    const used = new Set();
    const ordered = [];

    for (const k of PREFERRED_ORDER) {
      if (!(k in props)) continue;

      const norm =
        (k === "PROMOTOR_" || k === "PROMOTOR") ? "PROMOTOR" :
        (k === "CANTÓN" || k === "CANTON") ? "CANTON" :
        k;

      if (used.has(norm)) continue;
      used.add(norm);
      ordered.push(k);
    }

    const extras = keysInProps
      .filter(k => !PREFERRED_ORDER.includes(k))
      .sort((a,b) => a.localeCompare(b));

    const finalKeys = ordered.concat(extras);

    const rows = finalKeys.map(k => {
      let label = (LABELS[k] || k).trim();

      if (label === "PROMOTOR") {
        const val = getPromotor(props);
        if (!String(val ?? "").trim()) return "";
        return `<tr><th>${escapeHtml(label)}:</th><td>${formatValue(label, val)}</td></tr>`;
      }

      if (label === "CANTÓN") {
        const val = getCanton(props);
        if (!String(val ?? "").trim()) return "";
        return `<tr><th>${escapeHtml(label)}:</th><td>${formatValue(label, val)}</td></tr>`;
      }

      const v = props[k];
      if (v === null || v === undefined || String(v).trim() === "") return "";
      return `<tr><th>${escapeHtml(label)}:</th><td>${formatValue(label, v)}</td></tr>`;
    }).join("");

    const lat = markerLatLng?.lat;
    const lng = markerLatLng?.lng;

    detailCard.innerHTML = `
      <div class="detail-title">${title}</div>
      <table class="detail-table">${rows}</table>

      <div class="detail-actions">
        <button class="mini-btn" id="btnCentrar">Centrar</button>
        <button class="mini-btn" id="btnLimpiarSel">Quitar selección</button>
      </div>
    `;

    // acciones
    const btnCentrar = document.getElementById('btnCentrar');
    const btnLimpiarSel = document.getElementById('btnLimpiarSel');

    btnCentrar.addEventListener('click', () => {
      if (typeof lat === "number" && typeof lng === "number") {
        map.setView([lat, lng], Math.max(map.getZoom(), 13), { animate: true });
      }
    });

    btnLimpiarSel.addEventListener('click', () => {
      clearSelection();
    });
  }

  function clearSelection() {
    if (selectedMarker) {
      selectedMarker.setIcon(normalIcon);
      selectedMarker = null;
    }
    detailCard.innerHTML = `
      <div class="hint">
        Haz clic en un punto del mapa para ver aquí la información del proyecto.
      </div>
    `;
  }

  // ====== FILTROS ======
  function populateProvincias() {
    const provs = getUniqueSorted(allFeatures.map(f => normalizeStr(getProvincia(f.properties || {}))));
    provinciaSelect.innerHTML = `<option value="">(Todas)</option>` +
      provs.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
  }

  function populateCantones(prov) {
    let cantones = allFeatures
      .filter(f => normalizeStr(getProvincia(f.properties || {})) === prov)
      .map(f => normalizeStr(getCanton(f.properties || {})));

    cantones = getUniqueSorted(cantones);

    cantonSelect.innerHTML = `<option value="">(Todos)</option>` +
      cantones.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

    cantonSelect.disabled = false;
  }

  function clearCantones() {
    cantonSelect.innerHTML = `<option value="">(Todos)</option>`;
    cantonSelect.disabled = true;
  }

  function applyFilters() {
    const prov = provinciaSelect.value ? normalizeStr(provinciaSelect.value) : "";
    const canton = (!cantonSelect.disabled && cantonSelect.value) ? normalizeStr(cantonSelect.value) : "";
    const q = buscarInput.value ? buscarInput.value.trim() : "";
    const qn = normalizeStr(q);

    const filtered = allFeatures.filter(f => {
      const p = f.properties || {};
      const fp = normalizeStr(getProvincia(p));
      const fc = normalizeStr(getCanton(p));

      if (prov && fp !== prov) return false;
      if (canton && fc !== canton) return false;

      if (qn) {
        const haystack = [
          getProp(p, ["PROYECTO","Proyecto","PROYECTO "]),
          getProp(p, ["NRO_REGIS","NRO_REG","REGISTRO","Registro"]),
          getPromotor(p)
        ].map(x => normalizeStr(x)).join(" | ");

        if (!haystack.includes(qn)) return false;
      }
      return true;
    });

    currentFiltered = filtered;
    renderFeatures(filtered);
    setStats(allFeatures.length, filtered.length, prov, canton, q);
    clearSelection();
  }

  function clearFilters() {
    provinciaSelect.value = "";
    buscarInput.value = "";
    clearCantones();
    currentFiltered = allFeatures;
    renderFeatures(allFeatures);
    setStats(allFeatures.length, allFeatures.length, "", "", "");
    clearSelection();
  }

  // ====== RENDER ======
  function clearAllLayers() {
    plainLayer.clearLayers();
    clusterLayer.clearLayers();
    if (map.hasLayer(clusterLayer)) map.removeLayer(clusterLayer);
    if (!map.hasLayer(plainLayer)) plainLayer.addTo(map);
  }

  function renderFeatures(features) {
    clearAllLayers();

    const useCluster = clusterToggle.checked;

    for (const f of features) {
      const coords = f.geometry?.coordinates;
      if (!coords || coords.length < 2) continue;

      const lng = coords[0], lat = coords[1];
      const marker = L.marker([lat, lng], { icon: normalIcon });

      marker.on('click', () => {
        // resaltar seleccionado
        if (selectedMarker && selectedMarker !== marker) selectedMarker.setIcon(normalIcon);
        selectedMarker = marker;
        marker.setIcon(selectedIcon);

        // pintar panel derecho
        renderDetail(f.properties || {}, marker.getLatLng());
      });

      if (useCluster) clusterLayer.addLayer(marker);
      else plainLayer.addLayer(marker);
    }

    if (useCluster) {
      map.addLayer(clusterLayer);
      if (clusterLayer.getLayers().length) map.fitBounds(clusterLayer.getBounds(), { padding: [20, 20] });
    } else {
      const bounds = L.latLngBounds([]);
      plainLayer.eachLayer(l => bounds.extend(l.getLatLng()));
      if (bounds.isValid()) map.fitBounds(bounds, { padding: [20, 20] });
    }
  }

  // ====== EVENTOS ======
  provinciaSelect.addEventListener('change', function() {
    const prov = provinciaSelect.value ? normalizeStr(provinciaSelect.value) : "";
    if (!prov) { clearCantones(); applyFilters(); return; }
    populateCantones(prov);
    cantonSelect.value = "";
    applyFilters();
  });

  cantonSelect.addEventListener('change', function() { applyFilters(); });
  buscarInput.addEventListener('input', debounce(applyFilters, 250));
  limpiarBtn.addEventListener('click', function() { clearFilters(); });
  clusterToggle.addEventListener('change', function() { renderFeatures(currentFiltered); clearSelection(); });

  // ====== CARGA DATOS ======
  fetch(DATA_URL)
    .then(r => r.json())
    .then(data => {
      allFeatures = data.features || [];
      currentFiltered = allFeatures;

      populateProvincias();
      renderFeatures(allFeatures);
      setStats(allFeatures.length, allFeatures.length, "", "", "");
    })
    .catch(err => {
      console.error(err);
      statsBox.textContent = "Error cargando el GeoJSON. Verifica el nombre del archivo y que esté en la raíz del repo.";
      alert("No se pudo cargar el GeoJSON. Revisa el nombre del archivo en GitHub.");
    });
</script>
</body>
</html>

