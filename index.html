<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>PROYECTOS DE VIVIENDA MITI - MITI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Evita 404 de favicon -->
  <link rel="icon" href="data:," />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }

    .app { height: 100%; display: grid; grid-template-columns: 340px 1fr; }

    .panel {
      padding: 14px 14px 12px 14px;
      border-right: 1px solid #ddd;
      background: #fff;
      overflow: auto;
    }

    .header { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .header img { height: 38px; width: auto; display:block; }

    .panel h1 {
      font-size: 16px;
      margin: 0;
      font-weight: 700;
      text-transform: uppercase;
      line-height: 1.2;
    }

    .panel .muted {
      color: #666;
      font-size: 12px;
      margin-bottom: 12px;
      line-height: 1.3;
    }

    label { display:block; font-size:12px; margin:10px 0 6px 0; font-weight:700; }

    select, input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 13px;
      outline: none;
      box-sizing: border-box;
    }

    .btn {
      margin-top: 10px;
      width: 100%;
      padding: 9px 10px;
      border: 1px solid #222;
      background: #222;
      color: white;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
    }
    .btn.secondary { background:#fff; color:#222; }

    .stats {
      margin-top: 10px;
      font-size: 12px;
      color: #333;
      padding: 10px;
      border-radius: 10px;
      background: #f6f6f6;
      line-height: 1.4;
    }

    .footer {
      margin-top: 12px;
      font-size: 11px;
      color: #666;
      line-height: 1.35;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 12px;
      color: #222;
      user-select: none;
    }
    .toggle input { width: auto; }

    #map { height: 100%; }

    /* Popup */
    .popup-wrap { max-height: 260px; overflow: auto; }
    .popup-title { font-weight: 700; margin: 0 0 6px 0; }
    table.popup-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    table.popup-table th { text-align: left; vertical-align: top; padding: 3px 6px 3px 0; white-space: nowrap; }
    table.popup-table td { padding: 3px 0; word-break: break-word; }

    /* Punto liviano */
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #2E7DF6;
      border: 1px solid rgba(0,0,0,0.25);
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }

    @media (max-width: 820px) {
      .app { grid-template-columns: 1fr; grid-template-rows: 290px 1fr; }
      .panel { border-right: none; border-bottom: 1px solid #ddd; }
    }
  </style>
</head>
<body>

<div class="app">
  <div class="panel">
    <div class="header" style="flex-direction:column; align-items:flex-start;">
  <img id="logoInst"
       src="logo_institucional.jpg"
       alt="Logo institucional"
       style="margin-bottom:6px;"
       onerror="window.__logoFallback && window.__logoFallback(this);" />

  <h1 style="margin:0; line-height:1.25;">
    PROYECTOS DE VIVIENDA MITI - MITI
  </h1>
</div>
    
    <div class="muted">
      Filtra por provincia y cantón. La búsqueda aplica automáticamente mientras escribes.
    </div>

    <label for="provinciaSelect">Provincia</label>
    <select id="provinciaSelect">
      <option value="">(Todas)</option>
    </select>

    <label for="cantonSelect">Cantón</label>
    <select id="cantonSelect" disabled>
      <option value="">(Todos)</option>
    </select>

    <label for="buscarInput">Buscar (proyecto / promotor / registro)</label>
    <input id="buscarInput" type="text" placeholder="Ej: Galilea, MIDUVI..., Los Prados..." />

    <div class="toggle">
      <input type="checkbox" id="clusterToggle" checked />
      <label for="clusterToggle" style="margin:0; font-weight:700;">Agrupar puntos (clúster)</label>
    </div>

    <button class="btn secondary" id="limpiarBtn">Limpiar</button>

    <div class="stats" id="statsBox">Cargando datos…</div>

    <div class="footer">
      <strong>Fuente:</strong> Registro de Viviendas del Programa Miti-Miti – Ministerio de Infraestructura y Transporte.<br>
      <strong>Actualización:</strong> <span id="fechaActualizacion">2026-01-21</span>
    </div>
  </div>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
  // ====== FALLBACK DE LOGO (prueba varias rutas/formatos) ======
  window.__logoFallback = (function(){
    const candidates = [
      "logo_institucional.jpg",
      "logo_institucional.jpeg",
      "logo_institucional.png",
      "logo_institucional.svg",
      "logo_institucional"          // por si lo subiste sin extensión
    ];
    let idx = 0;
    return function(img){
      idx++;
      if (idx >= candidates.length) {
        // Si no existe ningún logo, ocultamos el <img> para que no quede el ícono roto
        img.style.display = "none";
        return;
      }
      img.onerror = function(){ window.__logoFallback(img); };
      img.src = candidates[idx];
    };
  })();

  // ====== CONFIG ======
  const DATA_URL = 'miti_miti_proyectos.geojson';
  const FECHA_ACTUALIZACION = '2026-01-21';
  document.getElementById('fechaActualizacion').textContent = FECHA_ACTUALIZACION;

  // ====== MAPA ======
  const map = L.map('map', { preferCanvas: true }).setView([-1.5, -78.5], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(map);

  let plainLayer = L.layerGroup().addTo(map);
  let clusterLayer = L.markerClusterGroup({
    chunkedLoading: true,
    removeOutsideVisibleBounds: true,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    maxClusterRadius: 45
  });

  // ====== UI ======
  const provinciaSelect = document.getElementById('provinciaSelect');
  const cantonSelect = document.getElementById('cantonSelect');
  const buscarInput = document.getElementById('buscarInput');
  const limpiarBtn = document.getElementById('limpiarBtn');
  const clusterToggle = document.getElementById('clusterToggle');
  const statsBox = document.getElementById('statsBox');

  // ====== ESTADO ======
  let allFeatures = [];
  let currentFiltered = [];

  // ====== UTIL ======
  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    }[m]));
  }

  function normalizeStr(s) {
    return String(s ?? "").toUpperCase().trim();
  }

  function getProp(props, keys) {
    for (const k of keys) {
      if (k in props && props[k] !== null && props[k] !== undefined && String(props[k]).trim() !== "") {
        return props[k];
      }
    }
    return "";
  }

  function getProvincia(props){
    return getProp(props, ["PROVINCIA", "Provincia", "provincia"]);
  }

  function getCanton(props){
    // Soporta con tilde y sin tilde
    return getProp(props, ["CANTÓN", "CANTON", "Canton", "cantón", "canton"]);
  }

  function getPromotor(props){
    return getProp(props, ["PROMOTOR_", "PROMOTOR", "PROMOTOR ", "PROMOTOR_ "]);
  }

  function formatValue(keyLabel, val) {
    if (val === null || val === undefined) return "";
    const s = String(val).trim();
    if (!s) return "";
    if (keyLabel === "WEB") {
      let u = s;
      if (u && !/^https?:\/\//i.test(u)) u = "https://" + u;
      return `<a href="${escapeHtml(u)}" target="_blank" rel="noopener">${escapeHtml(u)}</a>`;
    }
    return escapeHtml(s);
  }

  // Etiquetas institucionales (bonitas)
  const LABELS = {
    "NRO_REGIS": "REGISTRO",
    "PROYECTO": "PROYECTO",
    "PROVINCIA": "PROVINCIA",
    "CANTÓN": "CANTÓN",
    "CANTON": "CANTÓN",
    "PARROQUIA": "PARROQUIA",
    "SECTOR": "SECTOR",
    "VIVIENDAS": "VIVIENDAS",
    "TIPO_VIVIE": "TIPO VIVIENDA",
    "CONTACTO": "CONTACTO",
    "MAIL": "EMAIL",
    "WEB": "WEB",
    "PROMOTOR_": "PROMOTOR",
    "PROMOTOR": "PROMOTOR"
  };

  // Orden preferido (pero luego añadimos cualquier otro campo que exista)
  const PREFERRED_ORDER = [
    "NRO_REGIS",
    "PROYECTO",
    "PROVINCIA",
    "CANTÓN", "CANTON",
    "PARROQUIA",
    "SECTOR",
    "VIVIENDAS",
    "TIPO_VIVIE",
    "PROMOTOR_", "PROMOTOR",
    "CONTACTO",
    "MAIL",
    "WEB"
  ];

  function buildPopupHTML(props) {
    props = props || {};

    const proyecto = getProp(props, ["PROYECTO", "Proyecto", "PROYECTO "]);
    const title = proyecto ? escapeHtml(proyecto) : "Detalle";

    // Construimos lista de claves: primero las preferidas, luego el resto
    const keysInProps = Object.keys(props);
    const used = new Set();

    const ordered = [];
    for (const k of PREFERRED_ORDER) {
      // si la clave no existe, saltar
      if (!(k in props)) continue;

      // normalización para evitar duplicados PROMOTOR_/PROMOTOR, CANTÓN/CANTON
      const norm =
        (k === "PROMOTOR_" || k === "PROMOTOR") ? "PROMOTOR" :
        (k === "CANTÓN" || k === "CANTON") ? "CANTON" :
        k;

      if (used.has(norm)) continue;
      used.add(norm);
      ordered.push(k);
    }

    // añadimos extras (cualquier campo que no haya entrado)
    const extras = keysInProps
      .filter(k => !PREFERRED_ORDER.includes(k))
      .sort((a,b) => a.localeCompare(b));

    const finalKeys = ordered.concat(extras);

    // Generamos filas (con valor)
    const rows = finalKeys.map(k => {
      let label = (LABELS[k] || k).trim();

      // Caso especial: PROMOTOR (toma de PROMOTOR_ / PROMOTOR)
      if (label === "PROMOTOR") {
        const val = getPromotor(props);
        if (!String(val ?? "").trim()) return "";
        return `<tr><th>${escapeHtml(label)}:</th><td>${formatValue(label, val)}</td></tr>`;
      }

      // Caso especial: CANTÓN (toma CANTÓN o CANTON)
      if (label === "CANTÓN") {
        const val = getCanton(props);
        if (!String(val ?? "").trim()) return "";
        return `<tr><th>${escapeHtml(label)}:</th><td>${formatValue(label, val)}</td></tr>`;
      }

      // Normal
      const v = props[k];
      if (v === null || v === undefined || String(v).trim() === "") return "";
      return `<tr><th>${escapeHtml(label)}:</th><td>${formatValue(label, v)}</td></tr>`;
    }).join("");

    return `
      <div class="popup-wrap">
        <div class="popup-title">${title}</div>
        <table class="popup-table">${rows}</table>
      </div>
    `;
  }

  function getUniqueSorted(arr) {
    return Array.from(new Set(arr)).filter(Boolean).sort((a,b) => a.localeCompare(b));
  }

  function setStats(total, shown, prov, canton, q) {
    statsBox.innerHTML = `
      <strong>Total:</strong> ${total.toLocaleString()}<br>
      <strong>Mostrando:</strong> ${shown.toLocaleString()}<br>
      <strong>Provincia:</strong> ${prov || "(Todas)"}<br>
      <strong>Cantón:</strong> ${canton || "(Todos)"}<br>
      <strong>Búsqueda:</strong> ${q ? escapeHtml(q) : "(Ninguna)"}<br>
      <strong>Actualización:</strong> ${escapeHtml(FECHA_ACTUALIZACION)}
    `;
  }

  function debounce(fn, ms) {
    let t = null;
    return function(...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), ms);
    };
  }

  // ====== FILTROS ======
  function populateProvincias() {
    const provs = getUniqueSorted(allFeatures.map(f => normalizeStr(getProvincia(f.properties || {}))));
    provinciaSelect.innerHTML = `<option value="">(Todas)</option>` +
      provs.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
  }

  function populateCantones(prov) {
    let cantones = allFeatures
      .filter(f => normalizeStr(getProvincia(f.properties || {})) === prov)
      .map(f => normalizeStr(getCanton(f.properties || {})));

    cantones = getUniqueSorted(cantones);

    cantonSelect.innerHTML = `<option value="">(Todos)</option>` +
      cantones.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

    cantonSelect.disabled = false;
  }

  function clearCantones() {
    cantonSelect.innerHTML = `<option value="">(Todos)</option>`;
    cantonSelect.disabled = true;
  }

  function applyFilters() {
    const prov = provinciaSelect.value ? normalizeStr(provinciaSelect.value) : "";
    const canton = (!cantonSelect.disabled && cantonSelect.value) ? normalizeStr(cantonSelect.value) : "";
    const q = buscarInput.value ? buscarInput.value.trim() : "";
    const qn = normalizeStr(q);

    const filtered = allFeatures.filter(f => {
      const p = f.properties || {};

      const fp = normalizeStr(getProvincia(p));
      const fc = normalizeStr(getCanton(p));

      if (prov && fp !== prov) return false;
      if (canton && fc !== canton) return false;

      if (qn) {
        const haystack = [
          getProp(p, ["PROYECTO","Proyecto","PROYECTO "]),
          getProp(p, ["NRO_REGIS","NRO_REG","REGISTRO","Registro"]),
          getPromotor(p)
        ].map(x => normalizeStr(x)).join(" | ");

        if (!haystack.includes(qn)) return false;
      }
      return true;
    });

    currentFiltered = filtered;
    renderFeatures(filtered);
    setStats(allFeatures.length, filtered.length, prov, canton, q);
  }

  function clearFilters() {
    provinciaSelect.value = "";
    buscarInput.value = "";
    clearCantones();
    currentFiltered = allFeatures;
    renderFeatures(allFeatures);
    setStats(allFeatures.length, allFeatures.length, "", "", "");
  }

  // ====== RENDER ======
  const dotIcon = L.divIcon({
    className: "",
    html: `<div class="dot"></div>`,
    iconSize: [10,10],
    iconAnchor: [5,5]
  });

  function clearAllLayers() {
    plainLayer.clearLayers();
    clusterLayer.clearLayers();
    if (map.hasLayer(clusterLayer)) map.removeLayer(clusterLayer);
    if (!map.hasLayer(plainLayer)) plainLayer.addTo(map);
  }

  function renderFeatures(features) {
    clearAllLayers();
    const useCluster = clusterToggle.checked;

    for (const f of features) {
      const coords = f.geometry?.coordinates;
      if (!coords || coords.length < 2) continue;

      const lng = coords[0], lat = coords[1];
      const marker = L.marker([lat, lng], { icon: dotIcon });

      marker.on('click', () => {
        marker.bindPopup(buildPopupHTML(f.properties || {}), { maxWidth: 420 }).openPopup();
      });

      if (useCluster) clusterLayer.addLayer(marker);
      else plainLayer.addLayer(marker);
    }

    if (useCluster) {
      map.addLayer(clusterLayer);
      if (clusterLayer.getLayers().length) {
        map.fitBounds(clusterLayer.getBounds(), { padding: [20, 20] });
      }
    } else {
      const bounds = L.latLngBounds([]);
      plainLayer.eachLayer(l => bounds.extend(l.getLatLng()));
      if (bounds.isValid()) map.fitBounds(bounds, { padding: [20, 20] });
    }
  }

  // ====== EVENTOS ======
  provinciaSelect.addEventListener('change', function() {
    const prov = provinciaSelect.value ? normalizeStr(provinciaSelect.value) : "";
    if (!prov) { clearCantones(); applyFilters(); return; }
    populateCantones(prov);
    cantonSelect.value = "";
    applyFilters();
  });

  cantonSelect.addEventListener('change', function() { applyFilters(); });
  buscarInput.addEventListener('input', debounce(applyFilters, 250));
  limpiarBtn.addEventListener('click', function() { clearFilters(); });
  clusterToggle.addEventListener('change', function() { renderFeatures(currentFiltered); });

  // ====== CARGA DATOS ======
  fetch(DATA_URL)
    .then(r => r.json())
    .then(data => {
      allFeatures = data.features || [];
      currentFiltered = allFeatures;

      populateProvincias();
      renderFeatures(allFeatures);
      setStats(allFeatures.length, allFeatures.length, "", "", "");
    })
    .catch(err => {
      console.error(err);
      statsBox.textContent = "Error cargando el GeoJSON. Verifica el nombre del archivo y que esté en la raíz del repo.";
      alert("No se pudo cargar el GeoJSON. Revisa el nombre del archivo en GitHub.");
    });
</script>

</body>
</html>

